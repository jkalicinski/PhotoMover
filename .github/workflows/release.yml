name: Build & Release (Windows EXE)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10 (preview)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          allow-prerelease: true

      - name: Extract version from tag
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          echo "VERSION=$version" >> $env:GITHUB_ENV

      - name: Publish single-file EXE
        shell: pwsh
        run: |
          dotnet publish ./PhotoMover/PhotoMover.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            /p:PublishSingleFile=true `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            /p:EnableCompressionInSingleFile=true `
            /p:Version=$env:VERSION `
            /p:AssemblyVersion=$env:VERSION `
            /p:FileVersion=$env:VERSION `
            -o publish

      - name: Rename EXE with version
        shell: pwsh
        run: |
          Rename-Item publish/PhotoMover.exe PhotoMover-${{ env.VERSION }}-win-x64.exe

      - name: Generate SHA256 checksum
        shell: pwsh
        run: |
          Get-FileHash publish/PhotoMover-${{ env.VERSION }}-win-x64.exe -Algorithm SHA256 |
          ForEach-Object {
            "$($_.Hash)  PhotoMover-${{ env.VERSION }}-win-x64.exe"
          } | Out-File publish/PhotoMover-${{ env.VERSION }}-win-x64.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            publish/PhotoMover-${{ env.VERSION }}-win-x64.exe
            publish/PhotoMover-${{ env.VERSION }}-win-x64.sha256
